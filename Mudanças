CREATE TABLE MVM_MODELO_VEICULO_MARCA(
	PK_MVM_IDMODELO SERIAL,
	MVM_COD_IDMARCA INT,
	MVM_NOM_NOMEMARCA VARCHAR,
	MVM_NOM_NOMEMODELO VARCHAR,
	MVM_TIP_TIPOVEICULO VARCHAR,
	PRIMARY KEY(PK_MVM_IDMODELO)
);
SELECT*FROM MVM_MODELO_VEICULO_MARCA;
INSERT INTO MVM_MODELO_VEICULO_MARCA(MVM_NOM_NOMEMARCA,MVM_COD_IDMARCA,MVM_TIP_TIPOVEICULO,MVM_NOM_NOMEMODELO) VALUES 
	('MERCEDES',1,'CARRO','CLA 250 COUPÉ'),('MERCEDES',1,'CARRO','C180'),('PEUGEOT',2,'CARRO','PEUGEOT 208'),('PEUGEOT',2,'CARRO','BOXER'),
	('NISSAN',3,'CARRO','FRONTIER'),('NISSAN',3,'CARRO','KICKS'),('YAMAHA',4,'MOTO','NEO 125 USB'),('YAMAHA',4,'MOTO','FACTOR'),('HYUNDAI',5,'CARRO','HB20S'),('HYUNDAI',5,'CARRO','HB20');
ALTER TABLE VEI_VEICULO ADD FK_MVM_IDMODELO_VEI INT;
ALTER TABLE VEI_VEICULO ADD CONSTRAINT FK_MVM_IDMODELO_VEI FOREIGN KEY(FK_MVM_IDMODELO_VEI) REFERENCES MVM_MODELO_VEICULO_MARCA(PK_MVM_IDMODELO);
UPDATE VEI_VEICULO SET FK_MVM_IDMODELO_VEI = FK_MOD_IDMODELO_VEI;
-- ALTER TABLE VEI_VEICULO DROP COLUMN FK_MOD_IDMODELO_VEI; 


SELECT*FROM VEI_VEICULO;
SELECT*FROM MVM_MODELO_VEICULO_MARCA WHERE MVM_COD_IDMARCA = 4;

	
ALTER TABLE EST_ESTOQUE ADD EST_COD_FILIAL INT;
SELECT*FROM EST_ESTOQUE;
INSERT INTO EST_ESTOQUE(EST_DSC_ENDERECO,EST_NUM_NUMEROENDERECO,EST_COD_FILIAL) VALUES('AV. PADRE ANTÔNIO TÓMAS',5577,1), ('AV. WASHINGTON SOARES',77,2);
UPDATE EST_ESTOQUE SET EST_COD_FILIAL = 3 WHERE PK_EST_IDESTOQUE = 2;
INSERT INTO EST_ESTOQUE(EST_DSC_ENDERECO,EST_NUM_NUMEROENDERECO,EST_COD_FILIAL) VALUES('AV. PADRE ANTÔNIO TÓMAS',880,1);

SELECT*FROM VEI_vEICULO v
INNER JOIN VEN_VENDA ve ON v.PK_VEI_IDVEICULO = ve.FK_VEI_IDVEICULO_VEN;


-- TESTES DAS NOVIDADES
SELECT 
	v.PK_VEI_IDVEICULO,
	m.MOD_NOM_NOMEMODELO,
	ma.MAR_NOM_NOME,
	e.EST_DSC_ENDERECO,
	e.EST_NUM_NUMEROENDERECO,
	cli.CLI_NOM_NOME,
	ven.VEN_VLR_VENDA
FROM
	VEI_VEICULO v
JOIN 
	MOD_MODELO m ON v.FK_MOD_IDMODELO_VEI = m.PK_MOD_IDMODELO
JOIN 
	MAR_MARCA ma ON ma.PK_MAR_IDMARCA = m.FK_MAR_IDMARCA_MOD
JOIN
	RVE_RELACIONAMENTO_VEICULO_ESTOQUE rve ON rve.FK_VEI_IDVEICULO_RVE = v.PK_VEI_IDVEICULO
JOIN
	EST_ESTOQUE e ON e.PK_EST_IDESTOQUE = rve.FK_EST_IDESTOQUE_RVE
LEFT JOIN
	VEN_VENDA ven ON v.PK_VEI_IDVEICULO = ven.FK_VEI_IDVEICULO_VEN
LEFT JOIN 
	CLI_CLIENTE cli ON cli.PK_CLI_IDCLIENTE = ven.FK_CLI_IDCLIENTE_VEN;
	
SELECT*FROM VEI_VEICULO;
SELECT*FROM EST_ESTOQUE;
SELECT*FROM MVM_MODELO_VEICULO_MARCA;

-- USANDO A NOVA TABELA
SELECT
	v.PK_VEI_IDVEICULO,
	m.MVM_NOM_NOMEMODELO,
	m.MVM_NOM_NOMEMARCA,
	e.EST_DSC_ENDERECO,
	e.EST_NUM_NUMEROENDERECO,
	cli.CLI_NOM_NOME,
	ven.VEN_VLR_VENDA
FROM
	VEI_VEICULO v
JOIN 
	MVM_MODELO_VEICULO_MARCA m ON m.PK_MVM_IDMODELO = v.FK_MVM_IDMODELO_VEI
JOIN
	RVE_RELACIONAMENTO_VEICULO_ESTOQUE rve ON rve.FK_VEI_IDVEICULO_RVE = v.PK_VEI_IDVEICULO
JOIN
	EST_ESTOQUE e ON e.PK_EST_IDESTOQUE = rve.FK_EST_IDESTOQUE_RVE
LEFT JOIN
	VEN_VENDA ven ON v.PK_VEI_IDVEICULO = ven.FK_VEI_IDVEICULO_VEN
LEFT JOIN 
	CLI_CLIENTE cli ON cli.PK_CLI_IDCLIENTE = ven.FK_CLI_IDCLIENTE_VEN;


-- VERIFICAÇÃO DE ESPERANÇA DE GANHO DE UM FORNECEDOR, E QUEM POSSSUÍ A MELHOR MÉDIA
SELECT 
	fo.FOR_NOM_NOME,
	TO_CHAR(SUM(vei.VEI_VLR_VALORFORNECEDOR),'L999G999G999D99') AS VALOR_ESPERADO, 
	TO_CHAR((SUM(vei.VEI_VLR_VALORFORNECEDOR)/COUNT(*)),'L999G999G999D99') AS VALOR_MÉDIO_VENDA_POR_CARRO,
	COUNT(*) AS CARROS
FROM 
	VEI_VEICULO vei 
JOIN 
	FOR_FORNECEDOR fo ON fo.PK_FOR_IDFORNECEDOR = vei.FK_FOR_IDFORNECEDOR_VEI
GROUP BY fo.FOR_NOM_NOME
ORDER BY VALOR_MÉDIO_VENDA_POR_CARRO DESC;
	


